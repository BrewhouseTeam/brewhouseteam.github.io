

<!DOCTYPE html>
<!-- Hello, nice to see you took a peek here :) -->
<!-- Send us an email at hello at brewhouse dot io if you'd like to talk tech -->
<!--[if lt IE 7 ]> <html class="ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]>    <html class="ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]>    <html class="ie8" lang="en"> <![endif]-->
<!--[if IE 9 ]>    <html class="ie9" lang="en"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en"> <!--<![endif]-->

<html lang="en-us" class="blog">
  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# business: http://ogp.me/ns/business#">

    <title>Documented JSON-API with image upload</title>
    <meta property="og:title" content="Documented JSON-API with image upload">
    <meta property="og:site_name" content="brewhouse">
    <meta property="og:url" content="http://brewhouse.io/2016/05/20/documented-json-api-image-upload.html">

    <meta property="og:image" content="http://brewhouse.io/images/brewhouse-symbol-large-200x200.png">

    <meta property="twitter:card" content="summary" />
    <meta property="twitter:site" content="@brewhouseteam" />
    <meta property="twitter:image" content="http://brewhouse.io/images/brewhouse-symbol-large-200x200.png">
    <meta property="twitter:url" content="http://brewhouse.io/2016/05/20/documented-json-api-image-upload.html">

    <link rel="alternate" type="application/atom+xml" href="/blog/index.xml" title="The Brew Pub atom feed">

    
      <meta property="og:type" content="article">
      <meta property="article:published_time" content="2016-05-20 08:00:00 -0800">
      <meta property="article:tag" content="Paulo Ancheta">

      <meta property="twitter:title" content="Documented JSON-API with image upload">

      
        <meta name="description" content="Uploading Base 64 images using jsonapi-resources with good and up to date documentation">
        <meta property="twitter:description" content="Uploading Base 64 images using jsonapi-resources with good and up to date documentation">
        <meta property="og:description" content="Uploading Base 64 images using jsonapi-resources with good and up to date documentation">
      
    

    <script src="//use.typekit.net/scl6izu.js"></script>
    <script>try{Typekit.load();}catch(e){}</script>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="robots" content="INDEX, FOLLOW">

<link rel="shortcut icon" href="/images/icons/favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" href="/images/icons/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="57x57" href="/images/icons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="72x72" href="/images/icons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/images/icons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/images/icons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/images/icons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/images/icons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/images/icons/apple-touch-icon-152x152.png">

<link type="text/css" rel="stylesheet" href="/assets/application.css">


    <!-- needs to be refactored when we have more layouts -->
    

  </head>
  <body class="on-post">
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-46725009-2', 'brewhouse.io');
  ga('send', 'pageview');

</script>


    <aside class="offcanvas-menu">
  <ul>
    <li>
      <a class="internal" href="http://brewhouse.io/#work">Work</a>
    </li>
    <li>
      <a class="internal" href="http://brewhouse.io/#services">Services</a>
    </li>
    <li>
      <a href="/meet-the-team.html">Team</a>
    </li>
    <li>
      <a href="/blog">Blog</a>
    </li>
    <li>
      <a href="/show">Podcast</a>
    </li>
  </ul>
  <a class="btn btn--header" href="/work-with-us.html">Hire Us</a>
</aside>

    <nav id="navbar-main" class="navbar navbar-default navbar-main">
  <div class="container">
    <div class="col-xs-12">

      <div class="logo-container">
        <a id="brewhouse-logo" class="navbar-brand internal" rel="home" href="/" title="brewhouse logo"><img src="/images/brewhouse-logo.svg" alt="Brewhouse" class="img-responsive"></a>
      </div>

      <button type="button" class="navbar-toggle navbar-toggle-offcanvas js-navbar-toggle-offcanvas">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="main-menu">
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <a class="internal btn navbar-btn navbar-right btn--header" href="/work-with-us.html">Hire Us</a>
          <ul id="navbar-links" class="nav navbar-nav navbar-right">
            <li><a class="internal" href="/#work">Work</a></li>
            <li><a class="internal" href="/#services">Services</a></li>
            <li><a href="/meet-the-team.html">Team</a></li>
            <li><a href="/blog">Blog</a></li>
            <li><a href="/show">Podcast</a></li>
          </ul>
        </div><!-- /.navbar-collapse -->
      </div>

    </div>

  </div>
</nav>


    <div class="main">

      

<article>

  <div class="page-header">
    <div class="container">
      <div class="col-xs-12 col-sm-8">
        <h1 class="page-title">Documented JSON-API with image upload</h1>
      </div>
      <div class="col-xs-12 col-sm-4 text-xs-center">
        <div class="meta text-center">
          
            <div class="author">
              <img class="img-circle img-author" src="//www.gravatar.com/avatar/70952ec3d3d0677fbd24a03bc24d242b?s=135" alt="A photo of Paulo Ancheta" width="55">

              <a href="http://twitter.com/pauloancheta" target="_blank">Paulo Ancheta</a> 20 May 2016
            </div>
          
          <div class="social-actions">
            <a href="https://twitter.com/share?via=BrewhouseTeam" class="twitter-share-button" data-lang="en" data-url="http://brewhouse.io/2016/05/20/documented-json-api-image-upload.html" data-related="chancancode,kalv,pcreux,chuckbergeron" data-counturl="">Tweet</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="article-start" class="container content">

      <div class="col-xs-12 col-sm-8">

        <div class="post clearfix">

          <p>We’ve been working on a <a href="http://rubyonrails.org">Rails</a> app that uploads images using <code>carrierwave</code>.
We wanted to extend this functionality to enable our <a href="http://www.steamclock.com/">friends at Steamclock</a> to build a mobile app that upload images as well.
In order to make collaboration easy, we decided to follow the <a href="http://jsonapi.org/">JSON API specification</a> and to generate the API documentation.</p>

<!-- break -->

<h1 id="here-are-the-tools-that-we-are-going-to-use">Here are the tools that we are going to use</h1>

<ul>
  <li><a href="https://github.com/lebedev-yury/carrierwave-base64">carrierwave-base64</a> - Upload files encoded as base64 to carrierwave.</li>
  <li><a href="https://github.com/cerebris/jsonapi-resources">jsonapi-resources</a> - provides a framework for developing a server that complies with the JSON API specification.</li>
</ul>

<p><em>For The Stretch Goal</em></p>

<ul>
  <li><a href="https://github.com/zipmark/rspec_api_documentation">rspec_api_documentation</a> - Test your Rails API and generate documentation.</li>
  <li><a href="https://github.com/modeset/apitome">apitome</a> - Rails viewer for the documentation.</li>
</ul>

<h1 id="add-models-to-db-and-mounting-the-uploader">Add Models to DB and mounting the uploader</h1>

<p><em>Implementing carrierwave-base64</em></p>

<p>We need a place to store the images. We could use a generator to create a <code>Post</code> table that has an <code>image</code> column which stores strings.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">&gt;</span><span class="err">$</span> <span class="n">rails</span> <span class="n">g</span> <span class="n">model</span> <span class="n">post</span> <span class="ss">image</span><span class="p">:</span><span class="n">string</span>
<span class="o">&gt;</span><span class="err">$</span> <span class="n">rake</span> <span class="ss">db</span><span class="p">:</span><span class="n">migrate</span></code></pre></figure>

<p>With our generated model, we attach a base64 image uploader which will allow us to attach an object in the fields of our database. The code still looks like an ordinary <code>carrierwave</code> implementation – but with a really small difference. Instead of having <code>mount_uploader</code> in the model, we would add <code>mount_base64_uploader</code> instead.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># app/models/post.rb</span>
<span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">mount_base64_uploader</span> <span class="ss">:image</span><span class="p">,</span> <span class="no">ImageUploader</span>
<span class="k">end</span>

<span class="c1"># app/uploaders/image_uploader.rb</span>
<span class="k">class</span> <span class="nc">ImageUploader</span> <span class="o">&lt;</span> <span class="no">CarrierWave</span><span class="o">::</span><span class="no">Uploader</span><span class="o">::</span><span class="no">Base</span><span class="p">;</span> <span class="k">end</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># rails console</span>
<span class="nb">p</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">new</span>
<span class="n">base64_image</span> <span class="o">=</span> <span class="no">Base64</span><span class="o">.</span><span class="n">encode64</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">awesome_picture</span><span class="o">.</span><span class="n">jpg</span><span class="p">))</span>
<span class="nb">p</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="s2">&quot;data:image/jpg;base64,</span><span class="si">#{</span><span class="n">base64_image</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">p</span><span class="o">.</span><span class="n">save!</span></code></pre></figure>

<p>Now that can save a base64 image, we have to create an API endpoint that our mobile app can call so they can post images.</p>

<h1 id="creating-the-json-api-endpoint">Creating the JSON API Endpoint</h1>
<p><strong>implementing jsonapi-resources</strong></p>

<p>Although there is a lot more to explore in <code>jsonapi-resources</code>, I will only touch on just a few of its really cool features. I believe this gem deserves its own blog post on how much benefit it provides with just a few lines of code.</p>

<p>Now let’s create a <code>jsonapi-resources</code> controller and resource with generators that the gem provides.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">&gt;</span><span class="err">$</span> <span class="n">rails</span> <span class="n">generate</span> <span class="ss">jsonapi</span><span class="p">:</span><span class="n">resource</span> <span class="n">api</span><span class="o">/</span><span class="n">post</span>
<span class="c1"># =&gt; app/resources/api/post_resource.rb</span>
<span class="k">class</span> <span class="nc">Api</span><span class="o">::</span><span class="no">PostResource</span> <span class="o">&lt;</span> <span class="no">JSONAPI</span><span class="o">::</span><span class="no">Resource</span>
  <span class="n">attribute</span> <span class="ss">:image</span>
<span class="k">end</span>

<span class="c1"># app/controllers/api/application_controller.rb</span>
<span class="k">class</span> <span class="nc">Api</span><span class="o">::</span><span class="no">ApplicationController</span> <span class="o">&lt;</span> <span class="no">JSONAPI</span><span class="o">::</span><span class="no">ResourceController</span>
  <span class="n">protect_from_forgery</span> <span class="ss">with</span><span class="p">:</span> <span class="ss">:null_session</span>
<span class="k">end</span>

<span class="c1"># app/controllers/api/posts_controller.rb</span>
<span class="k">class</span> <span class="nc">Api</span><span class="o">::</span><span class="no">PostsController</span> <span class="o">&lt;</span> <span class="no">Api</span><span class="o">::</span><span class="no">ApplicationController</span><span class="p">;</span> <span class="k">end</span>

<span class="c1"># config/router.rb</span>
<span class="n">namespace</span> <span class="s2">&quot;api&quot;</span> <span class="k">do</span>
  <span class="n">jsonapi_resources</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:create</span><span class="o">]</span>
<span class="k">end</span></code></pre></figure>

<p>Although the <code>ApplicationController</code> that we have written inherits from the <code>jsonapi-resources</code> controller, this can also be a normal controller that includes a <code>ActsAsResourceController</code>.</p>

<p>In the routes, we are using the <code>jsonapi_resources</code> method. This gives us a lot of useful endpoints. For the sake of this example, let’s just focus on a posting endpoint and add <code>only: [:create]</code>. Thus giving:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">api_posts</span> <span class="nx">POST</span>   <span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">posts</span><span class="p">(.</span><span class="o">:</span><span class="nx">format</span><span class="p">)</span>           <span class="nx">api</span><span class="o">/</span><span class="nx">posts</span><span class="err">#</span><span class="nx">create</span></code></pre></figure>

<p>This is actually all we need to post a base64 image through an API. From here we can use <a href="https://www.getpostman.com/">Postman</a>:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">curl</span> <span class="o">-</span><span class="nx">X</span> <span class="nx">POST</span> <span class="o">-</span><span class="nx">H</span> <span class="s2">&quot;Content-Type: application/vnd.api+json&quot;</span> <span class="o">-</span><span class="nx">H</span> <span class="s2">&quot;Cache-Control: no-cache&quot;</span> <span class="o">-</span><span class="nx">H</span> <span class="s2">&quot;Postman-Token: 233cdeb0-ba65-7bd5-c550-8e8b79e181bb&quot;</span> <span class="o">-</span><span class="nx">d</span> <span class="s1">&#39;{</span>
<span class="s1">  &quot;data&quot;: {</span>
<span class="s1">      &quot;type&quot;: &quot;posts&quot;,</span>
<span class="s1">      &quot;attributes&quot;: { &quot;image&quot;: &quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2hpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpCQTg1MENEQjEyMjA2ODExQjI2OUUwNTczQjFGQjMxMyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDoyQjU5RTEyQkM3NjAxMUU0QTQ1NUJBOTY0QzkzRDVCMiIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDoyQjU5RTEyQUM3NjAxMUU0QTQ1NUJBOTY0QzkzRDVCMiIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M2IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkI4NTBDREIxMjIwNjgxMUIyNjlFMDU3M0IxRkIzMTMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkE4NTBDREIxMjIwNjgxMUIyNjlFMDU3M0IxRkIzMTMiLz4gPC9yZGY6RGVzY3Jp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&quot; }</span>
<span class="s1">  }</span>
<span class="s1">} &#39;</span> <span class="s2">&quot;http://localhost:3000/api/posts&quot;</span></code></pre></figure>

<hr />

<h1 id="stretch-goal-testing--documentation">Stretch Goal: Testing &amp; Documentation</h1>
<p><em>rspec api documentation</em></p>

<p>It is important to test and document API implementations. With <code>rspec_api_documentation</code>, we can do both at the same time. In my opinion, the best part of using this gem is that it does not generate wrong documentation for a failed example. Also, example documentation can be skipped with the <code>document: false</code> option.</p>

<p>First we need to tell <code>rspec_api_documentation</code> that we are going to be formatting the body to a <code>JSON</code> response by adding this helper:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># spec/rails_helper.rb</span>
<span class="c1"># Values listed are the default values</span>
<span class="no">RspecApiDocumentation</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1"># Change how the post body is formatted by default, you can still override by `raw_post`</span>
  <span class="c1"># Can be :json, :xml, or a proc that will be passed the params</span>
  <span class="n">config</span><span class="o">.</span><span class="n">request_body_formatter</span> <span class="o">=</span> <span class="ss">:json</span>
  <span class="n">config</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="ss">:json</span>
<span class="k">end</span></code></pre></figure>

<p>Now that is all set up, we can start writing our test.</p>

<p>To set up our test, we include <code>rspec_api_documentation</code> dsl. This gives us wrappers to have headers to our requests and setting HTTP verbs as context. We also use <code>resource</code> instead of <code>describe</code> to define what we are testing.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># spec/acceptance/post_spec.rb</span>
<span class="nb">require</span> <span class="s2">&quot;rails_helper&quot;</span>
<span class="nb">require</span> <span class="s2">&quot;rspec_api_documentation/dsl&quot;</span>

<span class="n">resource</span> <span class="s2">&quot;Posts&quot;</span> <span class="k">do</span>
  <span class="n">let!</span><span class="p">(</span><span class="ss">:valid_base64_image</span><span class="p">){</span> <span class="no">Base64</span><span class="o">.</span><span class="n">encode64</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">awesome_picture</span><span class="o">.</span><span class="n">jpg</span><span class="p">))</span> <span class="p">}</span>
  <span class="n">let!</span><span class="p">(</span><span class="ss">:request_attributes</span><span class="p">){</span>
    <span class="p">{</span><span class="ss">data</span><span class="p">:</span> <span class="p">{</span><span class="ss">type</span><span class="p">:</span> <span class="s2">&quot;posts&quot;</span><span class="p">,</span> <span class="ss">attributes</span><span class="p">:</span> <span class="p">{</span><span class="ss">image</span><span class="p">:</span> <span class="s2">&quot;data:image/png;base64,</span><span class="si">#{</span><span class="n">valid_base64_image</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}}</span>
  <span class="p">}</span>

  <span class="n">header</span> <span class="s2">&quot;Accept&quot;</span><span class="p">,</span> <span class="s2">&quot;application/vnd.api+json&quot;</span>
  <span class="n">header</span> <span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;application/vnd.api+json&quot;</span>
<span class="k">end</span></code></pre></figure>

<p>Below I have added a method that will be passed in a request method in my “example” (“example” in an acceptance test is analogous to an <code>it</code> block). A header method takes in 2 arguments: the header field name as a string and the header value.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">resource</span> <span class="s2">&quot;Posts&quot;</span> <span class="k">do</span>
  <span class="c1"># ... lines ommitted</span>

  <span class="n">post</span> <span class="s2">&quot;/api/posts&quot;</span> <span class="k">do</span>
    <span class="n">example</span> <span class="s2">&quot;Post a photo&quot;</span> <span class="k">do</span>
      <span class="n">do_request</span><span class="p">(</span><span class="n">request_attributes</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">eq</span> <span class="mi">201</span>

      <span class="n">images</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response_body</span><span class="p">)</span>
                   <span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
                   <span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;attributes&quot;</span><span class="p">)</span>
                   <span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">&quot;image&quot;</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">images</span><span class="o">[</span><span class="s2">&quot;image&quot;</span><span class="o">][</span><span class="s2">&quot;url&quot;</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be_present</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Now, let’s examine what goes in the test. In <code>rspec</code> we normally use <code>describe</code> or <code>context</code>. In an <code>rspec_api_documentation</code> test, we use the http verb, followed by the path that we want to test. It also takes in a block that contains a <code>do_request</code> method. This method can take in an argument. In a <code>GET</code> request, it does not need an argument, but for our case, the <code>POST</code> request takes in a hash as an argument.</p>

<p>Run the test and generate the docs with:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">&gt;</span><span class="err">$</span> <span class="n">rake</span> <span class="ss">docs</span><span class="p">:</span><span class="n">generate</span>

<span class="c1"># Or just run the test without generating the documentation</span>
<span class="o">&gt;</span><span class="err">$</span> <span class="n">rspec</span> <span class="n">spec</span><span class="o">/</span><span class="n">acceptance</span></code></pre></figure>

<p>The docs are available at <code>localhost:3000/api/docs</code> and with the help of <code>apitome</code> they <a href="https://blog-jsonapi.herokuapp.com/api/docs">look really cool</a>! In essence, <code>apitome</code> is a wrapper for <code>rspec_api_documentation</code> to enhance the generated documentation.</p>

<p>Following the <a href="http://jsonapi.org/">JSON API specification</a> with the help of
<a href="https://github.com/cerebris/jsonapi-resources">jsonapi-resources</a>
enables us to ship a consistent API with little effort.</p>

<p>Our <a href="http://www.steamclock.com/">friends at Steamclock</a> take advantage
of the <a href="http://jsonapi.org/implementations/#client-libraries-ios">JSON API iOS
libraries</a>
to automagically map api data to models.</p>

<p>Finally, providing them with an up-to-date and tested API documentation is key to maintain an healthy relationship in an Agile world. :)</p>

<p>Here is an <a href="https://blog-jsonapi.herokuapp.com/">example app</a> to play around with! Feel free to <a href="https://blog-jsonapi.herokuapp.com/api/post">post images to this endpoint</a> or read the <a href="https://blog-jsonapi.herokuapp.com/api/docs">generated documentation</a>. You can also view the <a href="https://github.com/pauloancheta/json-api-base64">the repository here</a></p>


        </div><!-- /post -->

        <div class="hire-us-form text-center">
  <h2>Let's Work Together</h2>
  <h3>Find out why our transparent, collaborative process is the best way to make well-loved products.</h3>
  <a href="/work-with-us.html" class="btn btn--blue">Get in touch today</a>
</div>


        <div id="disqus_thread"></div>

        <!-- disqus -->
        <script type="text/javascript">
            var disqus_shortname = 'brewhouse';
            var disqus_url = 'http://brewhouse.io/2016/05/20/documented-json-api-image-upload.html';

            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        <!-- /disqus -->

      </div>

  </div><!-- /content-->

</article>

<script>
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
</script>


    </div>

    <aside class="lets-talk cover">
  <div class="container">
    <div class="col-md-6">
      <p class="lede">We partner with businesses to design and develop well-loved products through a flexible and transparent process. We'd love to discuss how our process can help your idea become a reality.</p>
    </div>
  </div>
  <div class="container">
    <div class="col-md-6">
      <a href="http://maps.apple.com/?q=210%20Carrall,+Vancouver,+Canada">#303 - 210 Carrall St, Vancouver, BC
      V6B 2J1</a><br>
      <a href="tel:+16047574242">+1 604-757-4242</a> &middot;
      <a href="mailto:hello@brewhouse.io">hello@brewhouse.io</a> &middot;
      <a href="http://twitter.com/brewhouseteam">@brewhouseteam</a>
    </div>
    <div class="col-md-5 col-md-offset-1">
      <a href="/work-with-us.html" class="btn btn--footer">Hire Us</a>
    </div>
  </div>
</aside>


    <footer id="footer">
  <div class="container">
    <nav role="navigation" class="col-md-6">
        <ul>
          <li>
            <a class="internal" href="/#work">Work</a>
          </li>
          <li>
            <a class="internal" href="/meet-the-team.html">Team</a>
          </li>
          <li>
            <a class="internal" href="/blog">Blog</a>
          </li>          
          <li>
            <a class="internal" href="/show">Podcast</a>
          </li>
        </ul>
    </nav>
    <div class="col-md-5 col-md-push-1">
      <p class="copyright">
        &copy; <span class="copyright-year"></span> <a href="http://brewhouse.io">brewhouse software, inc.</a>
      </p>
    </div>
  </div>
</footer>


    <script type="text/javascript" src="/assets/app.js"></script>

    <!-- needs to be refactored when we have more layouts -->
    

  </body>
</html>
