

<!DOCTYPE html>
<!-- Hello, nice to see you took a peek here :) -->
<!-- Send us an email at hello at brewhouse dot io if you'd like to talk tech -->
<!--[if lt IE 7 ]> <html class="ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]>    <html class="ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]>    <html class="ie8" lang="en"> <![endif]-->
<!--[if IE 9 ]>    <html class="ie9" lang="en"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en"> <!--<![endif]-->

<html lang="en-us" class="blog">
  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# business: http://ogp.me/ns/business#">

    <title>Advanced SQL in Rails - Part 2</title>
    <meta property="og:title" content="Advanced SQL in Rails - Part 2">
    <meta property="og:site_name" content="brewhouse">
    <meta property="og:url" content="http://brewhouse.io/2016/08/12/sql-in-rails-part2.html">

    <meta property="og:image" content="http://brewhouse.io/images/brewhouse-symbol-large-200x200.png">

    <meta property="twitter:card" content="summary" />
    <meta property="twitter:site" content="@brewhouseteam" />
    <meta property="twitter:image" content="http://brewhouse.io/images/brewhouse-symbol-large-200x200.png">
    <meta property="twitter:url" content="http://brewhouse.io/2016/08/12/sql-in-rails-part2.html">

    <link rel="alternate" type="application/atom+xml" href="/blog/index.xml" title="The Brew Pub atom feed">

    
      <meta property="og:type" content="article">
      <meta property="article:published_time" content="2016-08-12 09:00:00 -0800">
      <meta property="article:tag" content="Alex Taylor">

      <meta property="twitter:title" content="Advanced SQL in Rails - Part 2">

      
        <meta name="description" content="Turbocharge your Rails workflow by taking advantage of advanced SQL, right from within Rails.">
        <meta property="twitter:description" content="Turbocharge your Rails workflow by taking advantage of advanced SQL, right from within Rails.">
        <meta property="og:description" content="Turbocharge your Rails workflow by taking advantage of advanced SQL, right from within Rails.">
      
    

    <script src="//use.typekit.net/scl6izu.js"></script>
    <script>try{Typekit.load();}catch(e){}</script>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="robots" content="INDEX, FOLLOW">

<link rel="shortcut icon" href="/images/icons/favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" href="/images/icons/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="57x57" href="/images/icons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="72x72" href="/images/icons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/images/icons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/images/icons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/images/icons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/images/icons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/images/icons/apple-touch-icon-152x152.png">

<link type="text/css" rel="stylesheet" href="/assets/application.css">


    <!-- needs to be refactored when we have more layouts -->
    

  </head>
  <body class="on-post">
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-46725009-2', 'brewhouse.io');
  ga('send', 'pageview');

</script>


    <aside class="offcanvas-menu">
  <ul>
    <li>
      <a class="internal" href="http://brewhouse.io/#work">Work</a>
    </li>
    <li>
      <a class="internal" href="http://brewhouse.io/#services">Services</a>
    </li>
    <li>
      <a href="/meet-the-team.html">Team</a>
    </li>
    <li>
      <a href="/blog">Blog</a>
    </li>
    <li>
      <a href="/show">Podcast</a>
    </li>
  </ul>
  <a class="btn btn--header" href="/work-with-us.html">Hire Us</a>
</aside>

    <nav id="navbar-main" class="navbar navbar-default navbar-main">
  <div class="container">
    <div class="col-xs-12">

      <div class="logo-container">
        <a id="brewhouse-logo" class="navbar-brand internal" rel="home" href="/" title="brewhouse logo"><img src="/images/brewhouse-logo.svg" alt="Brewhouse" class="img-responsive"></a>
      </div>

      <button type="button" class="navbar-toggle navbar-toggle-offcanvas js-navbar-toggle-offcanvas">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="main-menu">
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <a class="internal btn navbar-btn navbar-right btn--header" href="/work-with-us.html">Hire Us</a>
          <ul id="navbar-links" class="nav navbar-nav navbar-right">
            <li><a class="internal" href="/#work">Work</a></li>
            <li><a class="internal" href="/#services">Services</a></li>
            <li><a href="/meet-the-team.html">Team</a></li>
            <li><a href="/blog">Blog</a></li>
            <li><a href="/show">Podcast</a></li>
          </ul>
        </div><!-- /.navbar-collapse -->
      </div>

    </div>

  </div>
</nav>


    <div class="main">

      

<article>

  <div class="page-header">
    <div class="container">
      <div class="col-xs-12 col-sm-8">
        <h1 class="page-title">Advanced SQL in Rails - Part 2</h1>
      </div>
      <div class="col-xs-12 col-sm-4 text-xs-center">
        <div class="meta text-center">
          
            <div class="author">
              <img class="img-circle img-author" src="//www.gravatar.com/avatar/da0b02303090f0ded442767e58a98626?s=135" alt="A photo of Alex Taylor" width="55">

              <a href="http://twitter.com/mctaylorpants" target="_blank">Alex Taylor</a> 12 Aug 2016
            </div>
          
          <div class="social-actions">
            <a href="https://twitter.com/share?via=BrewhouseTeam" class="twitter-share-button" data-lang="en" data-url="http://brewhouse.io/2016/08/12/sql-in-rails-part2.html" data-related="chancancode,kalv,pcreux,chuckbergeron" data-counturl="">Tweet</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="article-start" class="container content">

      <div class="col-xs-12 col-sm-8">

        <div class="post clearfix">

          <p>Welcome back, dear readers! In <a href="http://brewhouse.io/2016/08/04/sql-in-rails.html">part 1 of this post</a>, we did a quick overview of SQL’s window functions and views. Now, we’re going to see how we can use those features from right within Rails.</p>

<!-- break -->

<h2 id="putting-it-all-together">Putting it all together</h2>

<p>To demonstrate how we can spice up our Rails app with windows and views, let’s build a small Rails application called GifVotr. Think of it like Reddit for GIFs: you can post a GIF, and people can vote it up and down. The most popular GIFs will rise to the top.</p>

<p>We can start with some simple models and corresponding tables for GIFs and votes:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Gif</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:votes</span>
<span class="k">end</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Vote</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:gif</span>

  <span class="n">scope</span> <span class="ss">:upvotes</span><span class="p">,</span>   <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">value</span><span class="p">:</span>  <span class="mi">1</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:downvotes</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">value</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span></code></pre></figure>

<p>With these simple models (and a <a href="http://giphy.com/gifs/season-11-the-simpsons-11x22-l2JdWch9V8wsn4mAw">couple</a> <a href="http://giphy.com/gifs/hackers-hacking-FnGJfc18tDDHy">of</a> <a href="http://giphy.com/gifs/tim-and-eric-mind-blown-EldfH1VJdbrwY">fun</a> <a href="http://giphy.com/gifs/missiles-wargames-diBYl6TWc6pTW">GIFs</a>), we can issue queries like:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">gif</span> <span class="o">=</span> <span class="no">Gif</span><span class="o">.</span><span class="n">first</span>
<span class="c1"># =&gt; &lt;Gif ...&gt;</span>

<span class="n">gif</span><span class="o">.</span><span class="n">votes</span><span class="o">.</span><span class="n">upvotes</span><span class="o">.</span><span class="n">size</span>
<span class="c1"># =&gt; 12</span>

<span class="n">gif</span><span class="o">.</span><span class="n">votes</span><span class="o">.</span><span class="n">downvotes</span><span class="o">.</span><span class="n">size</span>
<span class="c1"># =&gt; 5</span></code></pre></figure>

<p>If we wanted to calculate the rank of each GIF, we could sum up the votes for each GIF and then sort by that:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Gif</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:votes</span>

  <span class="k">def</span> <span class="nf">score</span>
    <span class="n">votes</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="ss">:value</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">gif</span><span class="o">.</span><span class="n">score</span>
<span class="c1"># SELECT SUM(&quot;votes&quot;.&quot;value&quot;) FROM &quot;votes&quot; WHERE &quot;votes&quot;.&quot;gif_id&quot; = $1  [[&quot;gif_id&quot;, 7]]</span>
<span class="c1"># =&gt; 7</span></code></pre></figure>

<p>Our <code>score</code> method will issue a <code>sum</code> query every time it’s called, which will translate into a lot of additional queries as your dataset grows. Plus, we don’t just need to calculate the score - we also want to display the rank of each GIF - what’s the #1 most popular GIF, the #2 most popular, etc. Doing that in Ruby land will get expensive quickly.</p>

<h2 id="put-a-view-on-it">Put a view on it</h2>

<p>Instead, let’s make a view! We’ll start by loading up our database console using <code>rails db</code> and figure out how we can construct an SQL query that gives us the data we need. Remember, we’re looking for the score of each GIF, as well as its rank relative to all the GIFs in the system.</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">row_number</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">()</span> <span class="k">AS</span> <span class="n">id</span><span class="p">,</span>
<span class="n">total_votes</span><span class="p">.</span><span class="n">gif_id</span><span class="p">,</span>
<span class="n">total_votes</span><span class="p">.</span><span class="n">score</span><span class="p">,</span>
<span class="n">rank</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">total_votes</span><span class="p">.</span><span class="n">score</span> <span class="k">DESC</span><span class="p">)</span> <span class="k">AS</span> <span class="n">rank</span>
<span class="k">FROM</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">gif_id</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">AS</span> <span class="n">score</span>
  <span class="k">FROM</span> <span class="n">votes</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">gif_id</span>
<span class="p">)</span> <span class="k">AS</span> <span class="n">total_votes</span><span class="p">;</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"> <span class="n">id</span> <span class="o">|</span> <span class="n">gif_id</span> <span class="o">|</span> <span class="n">score</span> <span class="o">|</span> <span class="n">rank</span>
<span class="c1">----+--------+-------+------</span>
  <span class="mi">3</span> <span class="o">|</span>      <span class="mi">7</span> <span class="o">|</span>    <span class="mi">26</span> <span class="o">|</span>    <span class="mi">1</span>
  <span class="mi">1</span> <span class="o">|</span>      <span class="mi">8</span> <span class="o">|</span>    <span class="mi">22</span> <span class="o">|</span>    <span class="mi">2</span>
  <span class="mi">2</span> <span class="o">|</span>      <span class="mi">9</span> <span class="o">|</span>    <span class="mi">14</span> <span class="o">|</span>    <span class="mi">3</span>
<span class="p">(</span><span class="mi">3</span> <span class="k">rows</span><span class="p">)</span></code></pre></figure>

<p>This is a pretty complex query, so let’s break it down.</p>

<p>First, we need to calculate the score for each GIF. We can get this from the votes table with a basic aggregate function:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">SELECT</span> <span class="n">gif_id</span><span class="p">,</span> <span class="n">sum</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="no">AS</span> <span class="n">score</span>
<span class="no">FROM</span> <span class="n">votes</span> <span class="no">GROUP</span> <span class="no">BY</span> <span class="n">gif_id</span><span class="p">;</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"> <span class="n">gif_id</span> <span class="o">|</span> <span class="n">score</span>
<span class="o">--------+-------</span>
      <span class="mi">8</span> <span class="o">|</span>    <span class="mi">22</span>
      <span class="mi">9</span> <span class="o">|</span>    <span class="mi">14</span>
      <span class="mi">7</span> <span class="o">|</span>    <span class="mi">26</span>
<span class="p">(</span><span class="mi">3</span> <span class="n">rows</span><span class="p">)</span></code></pre></figure>

<p>Next, we want to take this result set and calculate a rank for each row, based on the score. The highest score will get the highest ranking. To do this, we can take the query above and use it in the <code>FROM</code> clause of our larger query, so that our calculations can operate on those results. We have to name this result set so that we can reference it in the rest of the query, so we’ll call it ‘total_votes’.</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="p">...</span>
<span class="k">FROM</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">gif_id</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">AS</span> <span class="n">score</span>
  <span class="k">FROM</span> <span class="n">votes</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">gif_id</span>
<span class="p">)</span> <span class="k">AS</span> <span class="n">total_votes</span><span class="p">;</span></code></pre></figure>

<p>We can use the <code>rank()</code> function to calculate the ranking for each row. Fun fact: you can’t use <code>rank()</code> without a window function, which makes it a pretty great example!</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="p">...,</span>
<span class="n">rank</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">total_votes</span><span class="p">.</span><span class="n">score</span> <span class="k">DESC</span><span class="p">)</span> <span class="k">AS</span> <span class="n">rank</span>
<span class="k">FROM</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">gif_id</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">AS</span> <span class="n">score</span>
  <span class="k">FROM</span> <span class="n">votes</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">gif_id</span>
<span class="p">)</span> <span class="k">AS</span> <span class="n">total_votes</span><span class="p">;</span></code></pre></figure>

<p>We need to give <code>rank()</code> a sorting by which it should rank our results, so we use a window function and instruct it to order the rows by score, descending. Unsurprisingly, we name this column ‘rank’.</p>

<p>Along with the ‘rank’ column, we also want to return the other columns from ‘total_votes’. While we’re at it, we should add an ‘id’ field so that our view feels like a real table:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">row_number</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">()</span> <span class="k">AS</span> <span class="n">id</span><span class="p">,</span>
<span class="n">total_votes</span><span class="p">.</span><span class="n">gif_id</span><span class="p">,</span>
<span class="n">total_votes</span><span class="p">.</span><span class="n">score</span><span class="p">,</span>
<span class="n">rank</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">total_votes</span><span class="p">.</span><span class="n">score</span> <span class="k">DESC</span><span class="p">)</span> <span class="k">AS</span> <span class="n">rank</span>
<span class="k">FROM</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">gif_id</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">AS</span> <span class="n">score</span>
  <span class="k">FROM</span> <span class="n">votes</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">gif_id</span>
<span class="p">)</span> <span class="k">AS</span> <span class="n">total_votes</span><span class="p">;</span></code></pre></figure>

<h2 id="waiter-theres-a-view-in-my-migration">Waiter, there’s a View in my Migration</h2>

<p>Okay, we’ve got our query! Now, we can hook it up to Rails. Let’s make a migration that will create this view in the database for us. We wrap our handcrafted query in a <code>CREATE VIEW</code> statement and call it ‘rankings’. We can use Active Record’s <code>execute</code> function to pass our SQL right into the database.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">CreateRankingsView</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="o">[</span><span class="mi">5</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">up</span>
    <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span>
<span class="sh">      CREATE VIEW rankings AS (</span>
<span class="sh">        SELECT row_number() OVER () AS id,</span>
<span class="sh">        total_votes.*,</span>
<span class="sh">        rank() OVER (ORDER BY total_votes.score DESC) AS rank</span>
<span class="sh">        FROM (</span>
<span class="sh">          SELECT gif_id, sum(value) AS score</span>
<span class="sh">          FROM votes GROUP BY gif_id</span>
<span class="sh">        ) AS total_votes</span>
<span class="sh">      )</span>
<span class="no">    SQL</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">down</span>
    <span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP VIEW rankings&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Here’s where we diverge a bit from the Rails Way of things, so it’s important to point out a few things:</p>

<ol>
  <li>
    <p>Since we’re passing raw SQL in this migration, we shouldn’t use the <code>change</code> method, since Rails won’t know how to reverse the migration. Instead, we should use <code>up</code>/<code>down</code> so that we can correctly drop the view if we need to roll it back.</p>
  </li>
  <li>
    <p>When new migrations are run, Rails updates <code>db/schema.rb</code> to reflect the current state of the database. Since we’re doing something custom now, <em>the result of this migration will not be visible in the schema file.</em> As a result, running <code>rails db:schema:load</code> will no longer put our database in the right state. This means that anywhere you rely on initializing the database from the schema - continuous integration, for example - you should simply use <code>rails db:migrate</code> instead.</p>
  </li>
</ol>

<p>(It’s worth mentioning here that <a href="https://thoughtbot.com/">thoughtbot</a> has created a gem called <a href="https://github.com/thoughtbot/scenic">Scenic</a> which solves this second problem, among others. If you find yourself working with views often, have a look at Scenic.)</p>

<p>Anyway, now we’ve got a view in our database. Following the Rails convention of table/model naming, we can hook up a Ranking model to this ‘table’ of ours:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Ranking</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">=</span> <span class="ss">:id</span>

  <span class="n">belongs_to</span> <span class="ss">:gif</span>
<span class="k">end</span></code></pre></figure>

<p>This looks like any other table-backed model, except for one small difference: we need to tell our model what its primary key is, since Rails can’t infer it from the schema.</p>

<p>Now that we’ve hooked up our view to a model, we’ve completely abstracted the fact that this is a complex SQL query, and we can proceed as if ‘rankings’ was actually a table.</p>

<p>Let’s fast-forward a bit and see how all three of these models could work together to produce a complex result set while hitting the database just once:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Gif</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:ranking</span>
  <span class="n">has_many</span> <span class="ss">:upvotes</span><span class="p">,</span>   <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">upvotes</span>   <span class="p">},</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">&quot;Vote&quot;</span>
  <span class="n">has_many</span> <span class="ss">:downvotes</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">downvotes</span> <span class="p">},</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">&quot;Vote&quot;</span>

  <span class="n">scope</span> <span class="ss">:with_votes</span><span class="p">,</span>    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">includes</span><span class="p">(</span><span class="ss">:upvotes</span><span class="p">,</span> <span class="ss">:downvotes</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:with_rankings</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">includes</span><span class="p">(</span><span class="ss">:ranking</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:order_by_rank</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">joins</span><span class="p">(</span><span class="ss">:ranking</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s1">&#39;rankings.rank&#39;</span><span class="p">,</span> <span class="s1">&#39;rankings.id&#39;</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">delegate</span> <span class="ss">:rank</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="ss">:ranking</span>

  <span class="k">def</span> <span class="nf">downvotes_count</span>
    <span class="n">downvotes</span><span class="o">.</span><span class="n">size</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">upvotes_count</span>
    <span class="n">upvotes</span><span class="o">.</span><span class="n">size</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Ranking</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">=</span> <span class="ss">:id</span>

  <span class="n">belongs_to</span> <span class="ss">:gif</span>
<span class="k">end</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">Vote</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:gif</span>

  <span class="n">scope</span> <span class="ss">:upvotes</span><span class="p">,</span>   <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">value</span><span class="p">:</span>  <span class="mi">1</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:downvotes</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">value</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span></code></pre></figure>

<p>(One thing to note about our <code>order_by_rank</code> scope: we’re explicitly ordering by <code>rank</code> and <code>id</code> in order to guarantee a consistent sort order, since our <code>rank()</code> function will assign the same rank to GIFs with equal scores. Sorting by <code>id</code> ensures that features like pagination will continue to work predictably. If you want to nerd out more on rank functions, check out <a href="https://oracle-base.com/articles/misc/rank-dense-rank-first-last-analytic-functions">this article</a>.)</p>

<p>Back in ActiveRecord land, we can harness the power of scopes and associations to construct an efficient database query, with all the data we need, up front:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="vi">@gifs</span> <span class="o">=</span> <span class="no">Gif</span><span class="o">.</span><span class="n">with_votes</span><span class="o">.</span><span class="n">with_rankings</span><span class="o">.</span><span class="n">order_by_rank</span>

<span class="c1"># SELECT &quot;gifs&quot;.&quot;id&quot; AS t0_r0, &quot;gifs&quot;.&quot;image&quot; AS t0_r1, &quot;gifs&quot;.&quot;created_at&quot; AS t0_r2, &quot;gifs&quot;.&quot;updated_at&quot; AS t0_r3, &quot;votes&quot;.&quot;id&quot; AS t1_r0, &quot;votes&quot;.&quot;gif_id&quot; AS t1_r1, &quot;votes&quot;.&quot;value&quot; AS t1_r2, &quot;votes&quot;.&quot;created_at&quot; AS t1_r3, &quot;votes&quot;.&quot;updated_at&quot; AS t1_r4, &quot;downvotes_gifs&quot;.&quot;id&quot; AS t2_r0, &quot;downvotes_gifs&quot;.&quot;gif_id&quot; AS t2_r1, &quot;downvotes_gifs&quot;.&quot;value&quot; AS t2_r2, &quot;downvotes_gifs&quot;.&quot;created_at&quot; AS t2_r3, &quot;downvotes_gifs&quot;.&quot;updated_at&quot; AS t2_r4, &quot;rankings&quot;.&quot;id&quot; AS t3_r0, &quot;rankings&quot;.&quot;gif_id&quot; AS t3_r1, &quot;rankings&quot;.&quot;score&quot; AS t3_r2, &quot;rankings&quot;.&quot;rank&quot; AS t3_r3 FROM &quot;gifs&quot; INNER JOIN &quot;rankings&quot; ON &quot;rankings&quot;.&quot;gif_id&quot; = &quot;gifs&quot;.&quot;id&quot; LEFT OUTER JOIN &quot;votes&quot; ON &quot;votes&quot;.&quot;gif_id&quot; = &quot;gifs&quot;.&quot;id&quot; AND &quot;votes&quot;.&quot;value&quot; = $1 LEFT OUTER JOIN &quot;votes&quot; &quot;downvotes_gifs&quot; ON &quot;downvotes_gifs&quot;.&quot;gif_id&quot; = &quot;gifs&quot;.&quot;id&quot; AND &quot;downvotes_gifs&quot;.&quot;value&quot; = $2 ORDER BY rankings.rank, &quot;gifs&quot;.&quot;id&quot; ASC  [[&quot;value&quot;, 1], [&quot;value&quot;, -1]] for those who scrolled to the end, I salute you!</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;ActiveRecord::Relation …&gt;</span>

<span class="vi">@gifs</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">rank</span>
<span class="o">=&gt;</span> <span class="mi">1</span>

<span class="vi">@gifs</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">upvotes_count</span>
 <span class="o">=&gt;</span> <span class="mi">30</span>

<span class="vi">@gifs</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">downvotes_count</span>
 <span class="o">=&gt;</span> <span class="mi">4</span></code></pre></figure>

<p>That’s quite the query, isn’t it? Bet you’re glad you didn’t have to worry about constructing <em>that</em> by hand!</p>

<h2 id="conclusion">Conclusion</h2>
<p>When the size and complexity of your data begins to outgrow ActiveRecord, you don’t need to <a href="http://giphy.com/gifs/harry-potter-hp-hagrid-2gGEWrIGVioP6">throw away all your Rails magic</a> just to get the results you need. With the right workflow, higher-level SQL features can integrate nicely with any Rails app. Your data will thank you!</p>

<p>Are you going to try out views and window functions on your next project? Are you working with them in your Rails app already? Drop me a line in the comments!</p>

<p>Related: <a href="http://brewhouse.io/2016/08/04/sql-in-rails.html">Advanced SQL in Rails - Part 1</a></p>


        </div><!-- /post -->

        <div class="hire-us-form text-center">
  <h2>Let's Work Together</h2>
  <h3>Find out why our transparent, collaborative process is the best way to make well-loved products.</h3>
  <a href="/work-with-us.html" class="btn btn--blue">Get in touch today</a>
</div>


        <div id="disqus_thread"></div>

        <!-- disqus -->
        <script type="text/javascript">
            var disqus_shortname = 'brewhouse';
            var disqus_url = 'http://brewhouse.io/2016/08/12/sql-in-rails-part2.html';

            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        <!-- /disqus -->

      </div>

  </div><!-- /content-->

</article>

<script>
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
</script>


    </div>

    <aside class="lets-talk cover">
  <div class="container">
    <div class="col-md-6">
      <p class="lede">We partner with businesses to design and develop well-loved products through a flexible and transparent process. We'd love to discuss how our process can help your idea become a reality.</p>
    </div>
  </div>
  <div class="container">
    <div class="col-md-6">
      <a href="http://maps.apple.com/?q=210%20Carrall,+Vancouver,+Canada">#303 - 210 Carrall St, Vancouver, BC
      V6B 2J1</a><br>
      <a href="tel:+16047574242">+1 604-757-4242</a> &middot;
      <a href="mailto:hello@brewhouse.io">hello@brewhouse.io</a> &middot;
      <a href="http://twitter.com/brewhouseteam">@brewhouseteam</a>
    </div>
    <div class="col-md-5 col-md-offset-1">
      <a href="/work-with-us.html" class="btn btn--footer">Hire Us</a>
    </div>
  </div>
</aside>


    <footer id="footer">
  <div class="container">
    <nav role="navigation" class="col-md-6">
        <ul>
          <li>
            <a class="internal" href="/#work">Work</a>
          </li>
          <li>
            <a class="internal" href="/meet-the-team.html">Team</a>
          </li>
          <li>
            <a class="internal" href="/blog">Blog</a>
          </li>          
          <li>
            <a class="internal" href="/show">Podcast</a>
          </li>
        </ul>
    </nav>
    <div class="col-md-5 col-md-push-1">
      <p class="copyright">
        &copy; <span class="copyright-year"></span> <a href="http://brewhouse.io">brewhouse software, inc.</a>
      </p>
    </div>
  </div>
</footer>


    <script type="text/javascript" src="/assets/app.js"></script>

    <!-- needs to be refactored when we have more layouts -->
    

  </body>
</html>
